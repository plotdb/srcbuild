// Generated by LiveScript 1.6.0
var fs, path, fsExtra, livescript, uglifyJs, aux, srcbuild, lscbuild;
fs = require('fs');
path = require('path');
fsExtra = require('fs-extra');
livescript = require('livescript');
uglifyJs = require('uglify-js');
aux = require('../aux');
srcbuild = require('../srcbuild');
lscbuild = function(opt){
  var this$ = this;
  opt == null && (opt = {});
  this.opt = opt;
  this.log = opt.logger || aux.logger;
  this.base = opt.base || '.';
  this.srcdir = path.normalize(path.join(this.base, opt.srcdir || 'src/ls'));
  this.desdir = path.normalize(path.join(this.base, opt.desdir || 'static/js'));
  this.builder = new srcbuild({
    base: this.srcdir,
    getDependencies: function(file){
      return [];
    },
    isSupported: function(file){
      return /\.ls$/.exec(file) && file.startsWith(this$.srcdir);
    },
    build: function(files){
      return this$.build(files);
    }
  });
  this.builder.init();
  return this;
};
lscbuild.prototype = import$(Object.create(Object.prototype), {
  getBuilder: function(){
    return this.builder;
  },
  build: function(files){
    var i$, len$, ref$, file, mtime, src, des, desMin, t1, code, desdir, codeMin, t2, e;
    for (i$ = 0, len$ = files.length; i$ < len$; ++i$) {
      ref$ = files[i$], file = ref$.file, mtime = ref$.mtime;
      src = file;
      des = src.replace(this.srcdir, this.desdir).replace(/\.ls$/, '.js');
      desMin = src.replace(this.srcdir, this.desdir).replace(/\.ls$/, '.min.js');
      if (!fs.existsSync(src) || aux.newer(des, mtime)) {
        continue;
      }
      try {
        t1 = Date.now();
        code = fs.readFileSync(src).toString();
        desdir = path.dirname(des);
        fsExtra.ensureDirSync(desdir);
        code = livescript.compile(fs.readFileSync(src).toString(), {
          bare: true,
          header: false
        });
        codeMin = uglifyJs.minify(code).code;
        fs.writeFileSync(des, code);
        fs.writeFileSync(desMin, codeMin);
        t2 = Date.now();
        this.log.info("[BUILD] " + src + " --> " + des + " / " + desMin + " ( " + (t2 - t1) + "ms )");
      } catch (e$) {
        e = e$;
        this.log.error("[BUILD] " + src + " failed: ");
        this.log.error(e.message.toString());
      }
    }
  }
});
module.exports = lscbuild;
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}